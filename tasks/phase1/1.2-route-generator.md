# ä»»åŠ¡ 1.2: è·¯ç”±ç”Ÿæˆå™¨

## åŸºæœ¬ä¿¡æ¯

- **ä»»åŠ¡ç¼–å·**: 1.2
- **Phase**: 1 - æ ¸å¿ƒè·¯ç”±ç³»ç»Ÿ
- **è´Ÿè´£äºº**: èµ„æ·±æ¶æ„å¸ˆ
- **é¢„è®¡å·¥æ—¶**: 2 å¤©
- **ä¼˜å…ˆçº§**: ğŸ”´ P0
- **ä¾èµ–**: ä»»åŠ¡ 1.1 (è·¯ç”±æ‰«æå™¨)

## ä»»åŠ¡æè¿°

åŸºäºè·¯ç”±æ‰«æå™¨çš„ç»“æœï¼Œç”Ÿæˆ TanStack Router å…¼å®¹çš„å®¢æˆ·ç«¯è·¯ç”±ä»£ç ã€‚

## äº¤ä»˜ç‰©

### 1. æ ¸å¿ƒæ–‡ä»¶

- `packages/framework/src/router/generator.ts` - è·¯ç”±ç”Ÿæˆå™¨ä¸»ç±»
- `packages/framework/src/router/templates.ts` - ä»£ç æ¨¡æ¿
- `packages/framework/src/router/client-entry.ts` - å®¢æˆ·ç«¯å…¥å£ç”Ÿæˆ

### 2. åŠŸèƒ½è¦æ±‚

- [ ] ç”Ÿæˆ TanStack Router `createFileRoute` ä»£ç 
- [ ] è‡ªåŠ¨æ³¨å…¥ loader ç±»å‹
- [ ] ç”Ÿæˆå®¢æˆ·ç«¯å…¥å£æ–‡ä»¶
- [ ] æ”¯æŒçƒ­é‡è½½
- [ ] ç”Ÿæˆè·¯ç”±æ¸…å• (manifest)
- [ ] ç±»å‹å®‰å…¨çš„ä»£ç ç”Ÿæˆ

### 3. è¾“å‡ºç¤ºä¾‹

```typescript
// ç”Ÿæˆçš„å®¢æˆ·ç«¯è·¯ç”±æ–‡ä»¶
// .framework/routes/posts/[postId].tsx
import { createFileRoute } from '@tanstack/solid-router'
import { queryClient } from '../query-client'

export const Route = createFileRoute('/posts/$postId')({
  loader: async ({ params, context }) => {
    const post = await context.queryClient.fetchQuery({
      queryKey: ['post', params.postId],
      queryFn: async () => {
        const res = await fetch(`${context.API_BASE}/api/posts/${params.postId}`)
        if (!res.ok) throw new Error('Post not found')
        return res.json()
      }
    })
    return { post }
  },

  component: () => {
    const { post } = Route.useLoaderData()
    return <div>{post.title}</div>
  }
})
```

## æŠ€æœ¯è¦æ±‚

### æ¨¡æ¿ç³»ç»Ÿ

```typescript
// packages/framework/src/router/templates.ts
export const pageTemplate = (route: Route) => `
import { createFileRoute } from '@tanstack/solid-router'

export const Route = createFileRoute('${route.path}')({
  loader: async ({ params, context }) => {
    // TODO: Implement data loading
    return { data: null }
  },
  
  component: ${route.componentName}
})

function ${route.componentName}() {
  const { data } = Route.useLoaderData()
  return <div>${route.path}</div>
}
`;
```

### å®¢æˆ·ç«¯å…¥å£

```typescript
// packages/framework/src/router/client-entry.ts
export function generateClientEntry(routes: Route[]): string {
  return `
import { createRouter, createMemoryHistory } from '@tanstack/solid-router'
import { QueryClient, QueryClientProvider } from '@tanstack/solid-query'

// å¯¼å…¥æ‰€æœ‰è·¯ç”±
${routes.map((r) => `import { Route as ${r.importName} } from './${r.file}'`).join("\n")}

const routeTree = ${generateRouteTree(routes)}

export const router = createRouter({
  history: createMemoryHistory(),
  routeTree,
  context: {
    queryClient: new QueryClient(),
    API_BASE: import.meta.env.VITE_API_BASE || '/api'
  }
})
`;
}
```

## å®ç°æ€è·¯

```typescript
// packages/framework/src/router/generator.ts
export class RouteGenerator {
  private outputDir: string;

  constructor(outputDir: string) {
    this.outputDir = outputDir;
  }

  async generate(routes: Route[]): Promise<{
    clientRoutes: string[];
    manifest: any;
  }> {
    // 1. ç”Ÿæˆå®¢æˆ·ç«¯è·¯ç”±æ–‡ä»¶
    const clientRoutes = await this.generateClientRoutes(routes);

    // 2. ç”Ÿæˆè·¯ç”±æ¸…å•
    const manifest = this.generateManifest(routes);

    // 3. ç”Ÿæˆå®¢æˆ·ç«¯å…¥å£
    await this.generateClientEntry(routes);

    return { clientRoutes, manifest };
  }

  private async generateClientRoutes(routes: Route[]): Promise<string[]> {
    // ä¸ºæ¯ä¸ªè·¯ç”±ç”Ÿæˆæ–‡ä»¶
  }

  private generateManifest(routes: Route[]): any {
    // ç”Ÿæˆè·¯ç”±æ¸…å•ï¼Œç”¨äº SSR
  }

  private async generateClientEntry(routes: Route[]): Promise<void> {
    // ç”Ÿæˆå…¥å£æ–‡ä»¶
  }
}
```

## æµ‹è¯•ç”¨ä¾‹

```typescript
// tests/unit/router/generator.test.ts
describe("RouteGenerator", () => {
  test("generates client route for static page", async () => {
    const generator = new RouteGenerator("./.framework/routes");
    const route = {
      path: "/about",
      file: "app/about/page.tsx",
      type: "page",
      params: [],
    };

    const result = await generator.generate([route]);
    expect(result.clientRoutes[0]).toContain("createFileRoute('/about')");
  });

  test("generates route with dynamic params", async () => {
    // æµ‹è¯•åŠ¨æ€è·¯ç”±ç”Ÿæˆ
  });

  test("generates manifest correctly", async () => {
    // æµ‹è¯•æ¸…å•ç”Ÿæˆ
  });
});
```

## éªŒæ”¶æ ‡å‡†

- [ ] ç”Ÿæˆçš„ä»£ç ç¬¦åˆ TanStack Router è§„èŒƒ
- [ ] ç±»å‹æ¨æ–­æ­£ç¡®
- [ ] çƒ­é‡è½½æ”¯æŒ
- [ ] è·¯ç”±æ¸…å•å®Œæ•´
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] ä¸æ‰«æå™¨é›†æˆæ­£å¸¸

## æ€§èƒ½è¦æ±‚

- ç”Ÿæˆé€Ÿåº¦ < 100ms (100 ä¸ªè·¯ç”±)
- å†…å­˜ä½¿ç”¨ < 50MB
- æ”¯æŒå¢é‡ç”Ÿæˆ

## ç›¸å…³æ–‡æ¡£

- [TanStack Router æ–‡æ¡£](https://tanstack.com/router)
- [è·¯ç”±ç³»ç»Ÿè®¾è®¡](../design-doc.md#1-è·¯ç”±ç³»ç»Ÿ)

---

**åˆ›å»ºæ—¶é—´**: 2026-01-15  
**æœ€åæ›´æ–°**: 2026-01-15  
**çŠ¶æ€**: å¾…å¼€å§‹
