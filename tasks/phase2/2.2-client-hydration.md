# 任务 2.2: 客户端水合

## 基本信息

- **任务编号**: 2.2
- **Phase**: 2 - SSR 渲染引擎
- **负责人**: 资深 Node 工程师
- **预计工时**: 1 天
- **优先级**: 🔴 P0
- **依赖**: 任务 2.1 (SSR 渲染器)

## 任务描述

实现客户端水合逻辑，从服务端注入的状态恢复应用。

## 交付物

### 1. 核心文件

- `packages/framework/src/client/hydration.ts` - 水合入口
- `packages/framework/src/client/entry.tsx` - 客户端入口模板
- `packages/framework/src/client/bootstrap.ts` - 启动逻辑

### 2. 功能要求

- [ ] 从 window 对象读取状态
- [ ] 恢复 QueryClient 状态
- [ ] 恢复 Router 状态
- [ ] 执行水合
- [ ] 错误边界处理

## 实现

```typescript
// packages/framework/src/client/hydration.ts
import { hydrate } from 'solid-js/web'
import { createRouter, createMemoryHistory } from '@tanstack/solid-router'
import { QueryClient, QueryClientProvider } from '@tanstack/solid-query'

export function hydrateApp() {
  // 1. 读取服务端注入的状态
  const dehydratedState = window.__DEHYDRATED_STATE__
  const routerState = window.__ROUTER_STATE__
  const user = window.__USER__
  const API_BASE = window.__API_BASE__ || '/api'

  // 2. 创建 QueryClient 并恢复状态
  const queryClient = new QueryClient()
  queryClient.hydrate(dehydratedState)

  // 3. 创建 Router
  const router = createRouter({
    history: createMemoryHistory({ initialEntries: [window.location.pathname] }),
    routeTree: window.__ROUTE_TREE__,
    context: {
      queryClient,
      user,
      API_BASE
    }
  })

  // 4. 恢复路由状态
  router.hydrate(routerState)

  // 5. 执行水合
  hydrate(() => {
    return (
      <QueryClientProvider client={queryClient}>
        {router.RootComponent}
      </QueryClientProvider>
    )
  }, document.getElementById('root')!)
}
```

## 验收标准

- [ ] 状态正确恢复
- [ ] 水合无闪烁
- [ ] 错误处理完善
- [ ] 类型安全

---

**创建时间**: 2026-01-15  
**状态**: 待开始
