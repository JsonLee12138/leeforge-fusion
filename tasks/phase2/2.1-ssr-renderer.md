# ä»»åŠ¡ 2.1: SSR æ¸²æŸ“å™¨

## åŸºæœ¬ä¿¡æ¯

- **ä»»åŠ¡ç¼–å·**: 2.1
- **Phase**: 2 - SSR æ¸²æŸ“å¼•æ“
- **è´Ÿè´£äºº**: èµ„æ·± Node å·¥ç¨‹å¸ˆ
- **é¢„è®¡å·¥æ—¶**: 2 å¤©
- **ä¼˜å…ˆçº§**: ğŸ”´ P0
- **ä¾èµ–**: ä»»åŠ¡ 1.2 (è·¯ç”±ç”Ÿæˆå™¨)

## ä»»åŠ¡æè¿°

å®ç°æœåŠ¡ç«¯æ¸²æŸ“æ ¸å¿ƒé€»è¾‘ï¼Œé›†æˆ TanStack Router SSRï¼Œæ”¯æŒæ•°æ®é¢„å–å’Œ HTML ç”Ÿæˆã€‚

## äº¤ä»˜ç‰©

### 1. æ ¸å¿ƒæ–‡ä»¶

- `packages/framework/src/ssr/renderer.ts` - SSR æ¸²æŸ“å™¨ä¸»ç±»
- `packages/framework/src/ssr/template.ts` - HTML æ¨¡æ¿
- `packages/framework/src/ssr/hydration.ts` - æ°´åˆçŠ¶æ€æ³¨å…¥

### 2. åŠŸèƒ½è¦æ±‚

- [ ] TanStack Router SSR é›†æˆ
- [ ] æ•°æ®é¢„å–æ‰§è¡Œ
- [ ] HTML ç”Ÿæˆ
- [ ] çŠ¶æ€æ°´åˆæ³¨å…¥
- [ ] é”™è¯¯å¤„ç†
- [ ] æ€§èƒ½ç›‘æ§

### 3. æ¸²æŸ“æµç¨‹

```
1. æ¥æ”¶è¯·æ±‚ URL
2. åŒ¹é…è·¯ç”±
3. æ‰§è¡Œ Loader (æœåŠ¡ç«¯)
4. æ¸²æŸ“ç»„ä»¶åˆ°å­—ç¬¦ä¸²
5. æ³¨å…¥æ°´åˆçŠ¶æ€
6. è¿”å›å®Œæ•´ HTML
```

## æŠ€æœ¯è¦æ±‚

### æ¸²æŸ“å™¨æ¥å£

```typescript
// packages/framework/src/ssr/renderer.ts
export interface SSRRenderOptions {
  url: string;
  context: AppContext;
  template?: string;
}

export interface SSRResult {
  html: string;
  dehydratedState: any;
  routerState: any;
  status: number;
  headers: Record<string, string>;
}

export class SSRRenderer {
  constructor(options: { routes: RouteTree; queryClient: QueryClient });

  render(options: SSRRenderOptions): Promise<SSRResult>;
}
```

### HTML æ¨¡æ¿

```typescript
// packages/framework/src/ssr/template.ts
export function generateHTML(options: {
  appHtml: string;
  dehydratedState: any;
  routerState: any;
  user?: any;
}): string {
  return `
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Leeforge App</title>
  </head>
  <body>
    <div id="root">${options.appHtml}</div>
    <script>
      window.__DEHYDRATED_STATE__ = ${JSON.stringify(options.dehydratedState)}
      window.__ROUTER_STATE__ = ${JSON.stringify(options.routerState)}
      window.__USER__ = ${JSON.stringify(options.user)}
    </script>
    <script type="module" src="/src/client/entry.tsx"></script>
  </body>
</html>
`;
}
```

### æ¸²æŸ“å®ç°

```typescript
// packages/framework/src/ssr/renderer.ts
import { renderToStringAsync } from "solid-js/web";
import { createMemoryHistory, createRouter } from "@tanstack/solid-router";
import { QueryClient, dehydrate } from "@tanstack/solid-query";

export class SSRRenderer {
  private routes: RouteTree;
  private queryClient: QueryClient;

  constructor(options: { routes: RouteTree; queryClient: QueryClient }) {
    this.routes = options.routes;
    this.queryClient = options.queryClient;
  }

  async render(options: SSRRenderOptions): Promise<SSRResult> {
    const start = Date.now();

    try {
      // 1. åˆ›å»ºå†…å­˜å†å²
      const history = createMemoryHistory({ initialEntries: [options.url] });

      // 2. åˆ›å»º Router
      const router = createRouter({
        history,
        routeTree: this.routes,
        context: {
          queryClient: this.queryClient,
          user: options.context.user,
          API_BASE: options.context.API_BASE,
        },
      });

      // 3. æ‰§è¡Œ Loader (è§¦å‘æ•°æ®é¢„å–)
      await router.load();

      // 4. æ¸²æŸ“åˆ°å­—ç¬¦ä¸²
      const appHtml = await renderToStringAsync(() => router.RootComponent);

      // 5. åºåˆ—åŒ–çŠ¶æ€
      const dehydratedState = dehydrate(this.queryClient);
      const routerState = router.state;

      // 6. ç”Ÿæˆ HTML
      const html = generateHTML({
        appHtml,
        dehydratedState,
        routerState,
        user: options.context.user,
      });

      return {
        html,
        dehydratedState,
        routerState,
        status: 200,
        headers: {
          "Content-Type": "text/html; charset=utf-8",
          "X-Render-Time": `${Date.now() - start}ms`,
        },
      };
    } catch (error) {
      // é”™è¯¯å¤„ç†
      return this.handleError(error);
    }
  }

  private handleError(error: any): SSRResult {
    console.error("SSR Error:", error);

    return {
      html: `
        <div class="error">
          <h1>500 - Server Error</h1>
          <p>${error.message}</p>
        </div>
      `,
      dehydratedState: {},
      routerState: {},
      status: 500,
      headers: { "Content-Type": "text/html" },
    };
  }
}
```

## æµ‹è¯•ç”¨ä¾‹

```typescript
// tests/integration/ssr/renderer.test.ts
describe("SSRRenderer", () => {
  let renderer: SSRRenderer;
  let queryClient: QueryClient;

  beforeEach(() => {
    queryClient = new QueryClient();
    renderer = new SSRRenderer({
      routes: mockRoutes,
      queryClient,
    });
  });

  test("renders basic page", async () => {
    const result = await renderer.render({
      url: "/",
      context: {
        API_BASE: "/api",
        queryClient,
        request: new Request("http://localhost/"),
      },
    });

    expect(result.status).toBe(200);
    expect(result.html).toContain('<div id="root">');
    expect(result.dehydratedState).toBeDefined();
  });

  test("handles 404", async () => {
    const result = await renderer.render({
      url: "/nonexistent",
      context: { API_BASE: "/api", queryClient },
    });

    expect(result.status).toBe(404);
  });

  test("injects user context", async () => {
    const result = await renderer.render({
      url: "/dashboard",
      context: {
        API_BASE: "/api",
        queryClient,
        user: { id: 1, name: "Test User" },
      },
    });

    expect(result.html).toContain("window.__USER__");
  });
});
```

## æ€§èƒ½è¦æ±‚

- é¦–æ¬¡æ¸²æŸ“ < 500ms
- åç»­æ¸²æŸ“ < 200ms
- å†…å­˜ä½¿ç”¨ < 100MB
- æ”¯æŒå¹¶å‘è¯·æ±‚

## é”™è¯¯å¤„ç†

```typescript
// é”™è¯¯ç±»å‹
export class SSRError extends Error {
  constructor(
    message: string,
    public status: number = 500,
    public originalError?: any,
  ) {
    super(message);
  }
}

// ä½¿ç”¨ç¤ºä¾‹
if (!route) {
  throw new SSRError("Route not found", 404);
}
```

## éªŒæ”¶æ ‡å‡†

- [ ] æ­£ç¡®æ¸²æŸ“é¡µé¢
- [ ] æ•°æ®é¢„å–æ­£å¸¸
- [ ] çŠ¶æ€æ°´åˆæ­£ç¡®
- [ ] é”™è¯¯å¤„ç†å®Œå–„
- [ ] æ€§èƒ½è¾¾æ ‡
- [ ] å•å…ƒ/é›†æˆæµ‹è¯•é€šè¿‡

## ç›¸å…³æ–‡æ¡£

- [SSR è®¾è®¡](../design-doc.md#2-æœåŠ¡ç«¯æ¸²æŸ“æµç¨‹)
- [TanStack Router SSR](https://tanstack.com/router/docs/guide/ssr)

---

**åˆ›å»ºæ—¶é—´**: 2026-01-15  
**æœ€åæ›´æ–°**: 2026-01-15  
**çŠ¶æ€**: å¾…å¼€å§‹
